---
version: '2.0'

st2ci.st2_docker_dev:
    type: direct
    input:
        - branch: "master"
        - project
        - build_parameters
        - circle_ci_project: "StackStorm/st2-docker"
        - notify_channels:
            - "#thunderdome"
        - notify_failure_channels:
            - "#thunderdome"
            - "#stackstorm"
        - webui_base_url: "https://st2cicd"

    tasks:
        build_pkgs_circle_ci:
            action: circle_ci.run_build
            input:
                project: <% $.circle_ci_project %>
                branch: <% $.branch %>
                username: StackStorm
                build_parameters:
                    "BUILD_DEV": true
            publish:
                PKG_BUILD_URL: <% task(build_pkgs_circle_ci).result.result.build_url %>
            on-success:
                - notify_success
            on-error:
                - notify_failure

        notify_success:
            with-items: channel in <% $.notify_channels %>
            action: slack.chat.postMessage
            input:
                channel: <% $.channel %>
                text: ""
                attachments: '[{"fallback": "[st2ci.st2_docker_dev: Completed]", "title": "[st2ci.st2_docker_dev: Completed]", "title_link": "<% $.webui_base_url %>/#/history/<% env().st2_execution_id %>/general", "text": "COMMITTER: <% coalesce($.committer, ''n/a'') %> \n GITHUB_URL: <% coalesce($.github_url, ''n/a'') %> \n CIRCLE_URL: <% coalesce($.circle_url, ''n/a'') %> \n PKG_BUILD_URL: <% coalesce($.PKG_BUILD_URL, ''n/a'') %>", "color": "#808080"}]'

        notify_failure:
            with-items: channel in <% $.notify_failure_channels %>
            action: slack.chat.postMessage
            input:
                channel: <% $.channel %>
                text: ""
                attachments: '[{"fallback": "[st2ci.st2_docker_dev: FAILED]", "title": "[st2cd.st2_docker_dev: FAILED]", "title_link": "<% $.webui_base_url %>/#/history/<% env().st2_execution_id %>/general", "text": "COMMITTER: <% coalesce($.committer, ''n/a'') %> \n GITHUB_URL: <% coalesce($.github_url, ''n/a'') %> \n CIRCLE_URL: <% coalesce($.circle_url, ''n/a'') %> \n PKG_BUILD_URL: <% coalesce($.PKG_BUILD_URL, ''n/a'') %>", "color": "#808080"}]'
