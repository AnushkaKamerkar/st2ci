version: '2.0'

st2ci.install_latest_revision_of_rpm_pkg:
  description: Install latest revision of a specified rpm package
  type: direct
  input:
    - host
    - pkg
    - version

  tasks:
    get_latest_revision:
      action: core.remote
      input:
        hosts: <% $.host %>
        cmd: repoquery --show-duplicates <% $.pkg %>-<% $.version %>* | sort --version-sort | tail -n 1
        timeout: 180
      publish:
        pkg_name_with_revision: <% task(get_latest_revision).result.get($.host).stdout %>
      on-complete:
        - upgrade_pkg_via_yum

    upgrade_pkg_via_yum:
      action: core.remote
      input:
        hosts: <% $.host %>
        cmd: sudo yum install -y <% $.pkg_name_with_revision %>
        timeout: 180
