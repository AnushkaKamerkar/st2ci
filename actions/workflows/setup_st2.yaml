---
version: '1.0'
description: Setup a running instance of StackStorm from git repo.
input:
  - host
  - repo
  - repo_branch
  - repo_dir
  - debug
vars:
  - clone_repo_iteration_count: 0
  - clone_path: null
output:
  - clone_path: <% ctx().clone_path %>
tasks:
  clone_repo:
    action: st2cd.git_clone
    input:
      hosts: <% ctx().host %>
      repo: <% ctx().repo %>
      branch: <% ctx().repo_branch %>
      target: <% ctx().repo_dir %>/st2_<% ctx().repo_branch %>
      timeout: 120
    next:
      - when: <% succeeded() %>
        publish:
          - clone_path: <% result().get(ctx().host).stdout %>
      - when: <% failed() %>
        do:
          - teardown_st2
  teardown_st2:
    action: st2ci.teardown_st2
    input:
      host: <% ctx().host %>
      repo: <% ctx().clone_path %>
