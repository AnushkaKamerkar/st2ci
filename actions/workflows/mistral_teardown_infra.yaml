version: '2.0'

st2ci.mistral_teardown_infra:
    description: Mistral teardown infra subworkflow
    type: direct
    input:
        - host
        - clones
        - backup: False
    tasks:
        init:
            action: std.noop
            on-complete:
                - backup_logs: <% $.backup %>
                - teardown_mistral: <% not $.backup and $.clones.get(mistral, '') != '' %>
                - teardown_st2: <% not $.backup and $.clones.get(st2, '') != '' %>
        backup_logs:
            action: st2ci.backup_logs
            input:
                hosts: <% $.host %>
                st2_execution_id: <% env().st2_execution_id %>
                mis_repo_dir: <% $.clones.get(mistral) %>
                mis_log_dir: /var/log
                st2_repo_dir: <% $.clones.get(st2) %>
                st2_log_dir: <% $.clones.get(st2) %>/logs
                backup_dir: /home/stanley/logs
            on-complete:
                - teardown_mistral: <% $.clones.get(mistral, '') != '' %>
                - teardown_st2: <% $.clones.get(st2, '') != '' %>
        teardown_mistral:
            action: mistral_dev.teardown
            input:
                host: <% $.host %>
                repo_main: <% $.clones.get(mistral) %>
                repo_client: <% $.clones.get(mistralclient) %>
                repo_action: <% $.clones.get(st2mistral) %>
        teardown_st2:
            action: st2ci.teardown_st2
            input:
                host: <% $.host %>
                repo: <% $.clones.get(st2) %>
