version: '2.0'

st2ci.install_latest_revision_of_deb_pkg:
  description: Install latest revision of a specified deb package
  type: direct
  input:
    - host
    - pkg
    - version

  tasks:
    get_latest_revision:
      action: core.remote
      input:
        hosts: <% $.host %>
        cmd: apt-cache show <% $.pkg %> | grep Version | awk '{print $2}' | grep <% $.version %> | sort --version-sort | tail -n 1
        timeout: 180
      publish:
        pkg_name_with_revision: '<% [$.pkg, task(get_latest_revision).result.get($.host).stdout].join("=") %>'
      on-complete:
        - upgrade_pkg_via_apt_get

    upgrade_pkg_via_apt_get:
      action: core.remote
      input:
        hosts: <% $.host %>
        cmd: sudo apt-get -o Dpkg::Options::="--force-confold" -y install --only-upgrade <% $.pkg_name_with_revision %>
        timeout: 180
