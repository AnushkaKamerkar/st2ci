version: '2.0'

st2ci.st2_pkg_upgrade_rpm:
    description: Upgrade StackStorm rpm packages on the box using yum.
    type: direct
    input:
        - host      # Host on which upgrade should be run
        - pkg_list  # List of packages to upgrade
        - version   # Version to upgrade to

    tasks:
        get_latest_revision:
            with-items: pkg in <% $.pkg_list %>
            concurrency: 1
            action: core.remote
            input:
                hosts: <% $.host %>
                cmd: apt-cache show <% $.pkg %> | grep Version | awk '{print $2}' | grep <% $.version %> | sort --version-sort | tail -n 1
                timeout: 180
            on-complete:
                - upgrade_pkgs_via_yum

        upgrade_pkgs_via_yum:
            with-items: pkg in <% $.pkg_list %>
            concurrency: 1
            action: core.remote
            input:
                hosts: <% $.host %>
                cmd: sudo yum update -y <% $.pkg %>
                timeout: 180
